<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="currentPage='files'">
<head>

    <!--<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet"/>-->
    <!--<link href="/css/bootstrap.min.css" rel="stylesheet"></link>-->
    <!--<link href="/css/bootstrap-responsive.min.css" rel="stylesheet"></link>-->
    <!--<link href="/css/style.css" rel="stylesheet"></link>-->

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel="stylesheet" href="http://getbootstrap.com/docs/3.3/examples/dashboard/dashboard.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css"/>
    <link ref="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css"/>
    <!--<link rel="stylesheet" href="/css/jquery.fileupload.css"/>-->
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">JSOCS Alpha</a>
        </div>
        <!--<div id="navbar" class="navbar-collapse collapse">-->
        <!--<ul class="nav navbar-nav navbar-right">-->
        <!--<li><a href="#">Dashboard</a></li>-->
        <!--<li><a href="#">Settings</a></li>-->
        <!--<li><a href="#">Profile</a></li>-->
        <!--<li><a href="#">Help</a></li>-->
        <!--</ul>-->
        <!--<form class="navbar-form navbar-right">-->
        <!--<input type="text" class="form-control" placeholder="Search...">-->
        <!--</form>-->
        <!--</div>-->
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
            <!--<ul class="nav nav-sidebar">-->
                <!--<li><a href="/accounts">Accounts</a></li>-->
                <!--<li class="active"><a href="/files">Files <span class="sr-only">(current)</span></a></li>-->
                <!--<li><a href="#">Storage</a></li>-->
                <!--<li><a href="#">Export</a></li>-->
            <!--</ul>-->
            <ul th:replace="commonSidebar"></ul>
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <h1 class="page-header">Files - <span th:text="${path}" id="current-path"></span></h1>

            <div class="table-responsive">
                <table class="table table-striped" id="fileTable">
                </table>
            </div>
            <br>
            <div>
                <a class="btn btn-info btn-sm refresh-btn">
                    <span class="glyphicon glyphicon-refresh"></span> Refresh
                </a>
                <a class="btn btn-info btn-sm upload-btn">
                    <span class="glyphicon glyphicon-upload"></span> Upload
                </a>
            </div>

            <p/>

            <hr/>

            <form enctype="multipart/form-data" id="upload-form" style="display:none"/>
                <input name="file" type="file" id="upload-file"/>
                <input type="button" value="Upload" id="upload-btn"/>
                <input name="path" type="text" id="upload-path"/>
            </form>

            <h3 class="page-information">Current Upload: <span id="upload-filename"></span>(<span id="upload-percent"></span>%)</h3>
            <div class="progress progress-striped active">
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>

            <!--<span id="upload-size"></span>-->

            <div id="dummy" style="display:none"></div>

            <!--<a class="btn btn-info btn-sm toggle-btn">-->
                <!--<span class="glyphicon glyphicon-upload"></span> Upload-->
            <!--</a>-->
        </div>
    </div>
</div>


</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
<script src="/js/jquery.ui.widget.js"></script>
<script src="/js/jquery.iframe-transport.js"></script>
<script src="/js/jquery.fileupload.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>
<script>
    $(function () {
        var table = $("#fileTable").DataTable({
            "ajax": "/api/files/r",
            "columns": [
                {
                    "render": function (data, type, row) {
                        if (row.cid == -1) {
                            return "<a class='change-path' href='javascript:void(0)'>" + row.cname + "</a>";
                            // return "";
                        } else if (row.cid == -2) {
                            return "<a class='change-parent' href='javascript:void(0)'>" + row.cname + "</a>";
                        } else {
                            return "<a class='download-url' href='javascript:void(0)'>" + data + "</a>";
                        }
                    },
                    "data": "cname"
                },
                {
                    "data": null,
                    "render": function (data, tyep, row) {
                        if (row.cid < 0) {
                            return "&nbsp;";
                        } else {
                            return "<button class='download-btn'>Download</button>" +
                                "<button class='delete-btn'>Delete</button>";
                        }
                    }
                }
            ]
        });

        //must use this format to attach event handler
        $('#fileTable tbody')
            .on('click', 'a.change-path', function () {
                var data = table.row($(this).parents('tr')).data();
                table.ajax.url("/api/files/r?path=" + data.cname);
                table.ajax.reload();
                var $curPath = $("#current-path");
                $curPath.empty();
                $curPath.append(data.cname);
            }).on('click', 'a.download-url', function () {
            var data = table.row($(this).parents('tr')).data();
            $("#dummy").empty();
            $("#dummy").append("<iframe src='/files/download" + data.cpath + data.cname + "'></iframe>");
        }).on('click', 'a.change-parent', function () {
            var data = table.row($(this).parents('tr')).data();

            var $curPath = $("#current-path");
            var curPath = $curPath.text();

            var finalPath = "/";
            if (curPath != '/') {
                var str = data.cname;
                var n = str.lastIndexOf("/");
                str = str.substr(0, n);
                n = str.lastIndexOf("/");
                finalPath = str.substr(0, n);
            }

            table.ajax.url("/api/files/r?path=" + finalPath);
            table.ajax.reload();

            $curPath.empty();
            $curPath.append(finalPath);
        }).on('click', 'button.delete-btn', function () {
            var data = table.row($(this).parents('tr')).data();
            var dialogRef = BootstrapDialog.confirm('Are you sure to delete this file?', function (result) {
                if (result) {
                    $.post('/api/files/d',
                        {
                            fileName: data.cpath + data.cname
                        }, function (data) {
                            if (data == 'success') {
                                dialogRef.close();
                                table.ajax.reload();
                                BootstrapDialog.alert('File deleted!');
                            } else {
                                BootstrapDialog.alert('Failed to delete file!');
                            }
                        });
                }
            });

        }).on('click', 'button.download-btn', function () {
            var data = table.row($(this).parents('tr')).data();
            $("#dummy").empty();
            $("#dummy").append("<iframe src='/files/download" + data.cpath + data.cname + "'></iframe>");
        });

        $(".refresh-btn").click(function () {
            table.ajax.reload();
        });

        // $(".delete-btn").click(function (event) {
        //     event.preventDefault();
        //     var fileName = $(this).attr('alt');
        //     alert(fileName);
        //     $.get('/api/files/d', {
        //         fileName: fileName
        //     }, function (data) {
        //         if (data == 'success') {
        //             alert('success');
        //         } else {
        //             alert('error');
        //         }
        //     });
        // });

        $(".upload-btn").click(function(){
            $("#upload-file").click();
        });

        $('#upload-file').on('change', function () {
            var file = this.files[0];

            var curPath = $("#current-path").text();

            if (file.size>0){
                $("#upload-filename").text(file.name);
                $("#upload-path").val(curPath+file.name);
                $("#upload-percent").text('0');

                $(".progress-bar")
                    .css('width','0%')
                    .attr('aria-valuenow',0);

                $.ajax({
                    // Your server script to process the upload
                    url: '/api/files/c',
                    type: 'POST',

                    // Form data
                    data: new FormData($('#upload-form')[0]),

                    // Tell jQuery not to process data or worry about content-type
                    // You *must* include these options!
                    cache: false,
                    contentType: false,
                    processData: false,

                    // Custom XMLHttpRequest
                    xhr: function () {
                        var myXhr = $.ajaxSettings.xhr();
                        if (myXhr.upload) {
                            // For handling the progress of the upload
                            myXhr.upload.addEventListener('progress', function (e) {
                                if (e.lengthComputable) {

                                    var percent = (e.loaded * 1.0 / e.total)*100;
                                    percent = parseInt(percent,10);

                                    $(".progress-bar")
                                        .css('width', percent +'%')
                                        .attr('aria-valuenow',percent)
                                        // .attr('aria-valuemax',e.total)
                                    ;

                                    $("#upload-percent").text(percent);
                                }
                            }, false);
                        }
                        return myXhr;
                    },

                    success: function () {
                        alert('success');
                        table.ajax.reload();
                    },

                    error: function (e) {
                        console.log(e);
                        alert('error');
                    }
                });
            }

            // if (file.size > 1024) {
            //     alert('max upload size is 1k')
            // }

            // Also see .name, .type
        });

    });
</script>
</html>