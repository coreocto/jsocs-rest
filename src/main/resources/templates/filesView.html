<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:with="currentPage='files'">
<head>
    <div th:replace="fragments/common-head"></div>
    <!--<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet"/>-->
    <!--<link href="/css/bootstrap.min.css" rel="stylesheet"></link>-->
    <!--<link href="/css/bootstrap-responsive.min.css" rel="stylesheet"></link>-->
    <!--<link href="/css/style.css" rel="stylesheet"></link>-->

    <div th:replace="fragments/bootstrapInclude :: css"></div>

    <div th:replace="fragments/common-css"></div>

    <div th:replace="fragments/datatablesInclude :: css"></div>
    <!--<link rel="stylesheet" href="/css/jquery.fileupload.css"/>-->
</head>
<body>

<div class="wrapper">
    <div th:replace="fragments/leftSidebar"></div>
    <!-- Page Content  -->
    <div id="content">
        <div th:replace="fragments/topNavBar"></div>
        <h1 class="page-header">Files - <span th:text="${path}" id="current-path"></span></h1>
        <table class="table table-striped" id="fileTable"></table>
        <p>
            <div>
                <!--<button type="button" id="sidebarCollapse" class="btn btn-info">-->
                    <!--<i class="fas fa-align-left"></i>-->
                    <!--<span>Toggle Sidebar</span>-->
                <!--</button>-->
                <button type="button" class="btn btn-info refresh-btn">
                    <span>Refresh</span>
                </button>
                <button type="button" class="btn btn-info upload-btn">
                    <span>Upload</span>
                </button>
                <!--<a class="btn btn-info refresh-btn">-->
                    <!--<span class="glyphicon glyphicon-refresh"></span> <span>Refresh</span>-->
                <!--</a>-->
                <!--<a class="btn btn-info upload-btn">-->
                    <!--<span class="glyphicon glyphicon-upload"></span> Upload-->
                <!--</a>-->
            </div>
        </p>
        <form enctype="multipart/form-data" id="upload-form" style="display:none">
            <input name="file" type="file" id="upload-file"/>
            <input type="button" value="Upload" id="upload-btn"/>
            <input name="path" type="text" id="upload-path"/>
        </form>
        <p>
            <h3 class="page-information">Current Upload: <span id="upload-filename"></span>(<span
                    id="upload-percent"></span>%)</h3>
            <div class="progress progress-striped active">
                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </p>


        <!--<span id="upload-size"></span>-->

        <div id="dummy" style="display:none"></div>
    </div>
</div>

<!--<nav class="navbar navbar-inverse navbar-fixed-top">-->
    <!--<div class="container-fluid">-->
        <!--<div class="navbar-header">-->
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"-->
                    <!--aria-expanded="false" aria-controls="navbar">-->
                <!--<span class="sr-only">Toggle navigation</span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
            <!--</button>-->
            <!--<a class="navbar-brand" href="#">JSOCS Alpha</a>-->
        <!--</div>-->
        <!--&lt;!&ndash;<div id="navbar" class="navbar-collapse collapse">&ndash;&gt;-->
        <!--&lt;!&ndash;<ul class="nav navbar-nav navbar-right">&ndash;&gt;-->
        <!--&lt;!&ndash;<li><a href="#">Dashboard</a></li>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><a href="#">Settings</a></li>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><a href="#">Profile</a></li>&ndash;&gt;-->
        <!--&lt;!&ndash;<li><a href="#">Help</a></li>&ndash;&gt;-->
        <!--&lt;!&ndash;</ul>&ndash;&gt;-->
        <!--&lt;!&ndash;<form class="navbar-form navbar-right">&ndash;&gt;-->
        <!--&lt;!&ndash;<input type="text" class="form-control" placeholder="Search...">&ndash;&gt;-->
        <!--&lt;!&ndash;</form>&ndash;&gt;-->
        <!--&lt;!&ndash;</div>&ndash;&gt;-->
    <!--</div>-->
<!--</nav>-->

<!--<div class="container-fluid">-->
    <!--<div class="row">-->
        <!--<div class="col-sm-3 col-md-2 sidebar">-->
            <!--&lt;!&ndash;<ul class="nav nav-sidebar">&ndash;&gt;-->
                <!--&lt;!&ndash;<li><a href="/accounts">Accounts</a></li>&ndash;&gt;-->
                <!--&lt;!&ndash;<li class="active"><a href="/files">Files <span class="sr-only">(current)</span></a></li>&ndash;&gt;-->
                <!--&lt;!&ndash;<li><a href="#">Storage</a></li>&ndash;&gt;-->
                <!--&lt;!&ndash;<li><a href="#">Export</a></li>&ndash;&gt;-->
            <!--&lt;!&ndash;</ul>&ndash;&gt;-->
            <!--<div th:replace="fragments\commonSidebar"></div>-->
        <!--</div>-->
        <!--<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">-->
            <!--<h1 class="page-header">Files - <span th:text="${path}" id="current-path"></span></h1>-->

            <!--<div class="table-responsive">-->
                <!--<table class="table table-striped" id="fileTable">-->
                <!--</table>-->
            <!--</div>-->
            <!--<br>-->
            <!--<div>-->
                <!--<a class="btn btn-info btn-sm refresh-btn">-->
                    <!--<span class="glyphicon glyphicon-refresh"></span> Refresh-->
                <!--</a>-->
                <!--<a class="btn btn-info btn-sm upload-btn">-->
                    <!--<span class="glyphicon glyphicon-upload"></span> Upload-->
                <!--</a>-->
            <!--</div>-->

            <!--<p/>-->

            <!--<hr/>-->

            <!--<form enctype="multipart/form-data" id="upload-form" style="display:none"/>-->
                <!--<input name="file" type="file" id="upload-file"/>-->
                <!--<input type="button" value="Upload" id="upload-btn"/>-->
                <!--<input name="path" type="text" id="upload-path"/>-->
            <!--</form>-->

            <!--<h3 class="page-information">Current Upload: <span id="upload-filename"></span>(<span id="upload-percent"></span>%)</h3>-->
            <!--<div class="progress progress-striped active">-->
                <!--<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>-->
            <!--</div>-->

            <!--&lt;!&ndash;<span id="upload-size"></span>&ndash;&gt;-->

            <!--<div id="dummy" style="display:none"></div>-->

            <!--&lt;!&ndash;<a class="btn btn-info btn-sm toggle-btn">&ndash;&gt;-->
                <!--&lt;!&ndash;<span class="glyphicon glyphicon-upload"></span> Upload&ndash;&gt;-->
            <!--&lt;!&ndash;</a>&ndash;&gt;-->
        <!--</div>-->
    <!--</div>-->
<!--</div>-->


</body>
<div th:replace="fragments/bootstrapInclude :: js"></div>
<div th:replace="fragments/jqueryUploadInclude :: js"></div>
<div th:replace="fragments/datatablesInclude :: js"></div>
<div th:replace="fragments/bootstrapDialogInclude :: js"></div>
<div th:replace="fragments/common-js"></div>
<script>
    $(function () {
        var table = $("#fileTable").DataTable({
            "ajax": "/api/files/r",
            "columns": [
                {
                    "title" : "File Name",
                    "render": function (data, type, row) {
                        if (row.cid == -1) {
                            return "<a class='change-path' href='javascript:void(0)'>" + row.cname + "</a>";
                            // return "";
                        } else if (row.cid == -2) {
                            return "<a class='change-parent' href='javascript:void(0)'>" + row.cname + "</a>";
                        } else {
                            return "<a class='download-url' href='javascript:void(0)'>" + data + "</a>";
                        }
                    },
                    "data": "cname"
                },
                {
                    "width": "10%",
                    "title": "Operations",
                    "data": null,
                    "render": function (data, tyep, row) {
                        if (row.cid < 0) {
                            return "&nbsp;";
                        } else {
                            return "<div class=\"btn-group\" role=\"group\">" +
                                "<button class='btn btn-secondary download-btn'>Download</button>" +
                                "<button class='btn btn-secondary delete-btn'>Delete</button>"+
                                "</div>";
                        }
                    }
                }
            ]
        });

        //must use this format to attach event handler
        $('#fileTable tbody')
            .on('click', 'a.change-path', function () {
                var data = table.row($(this).parents('tr')).data();
                table.ajax.url("/api/files/r?path=" + data.cname);
                table.ajax.reload();
                var $curPath = $("#current-path");
                $curPath.empty();
                $curPath.append(data.cname);
            }).on('click', 'a.download-url', function () {
            var data = table.row($(this).parents('tr')).data();
            $("#dummy").empty();
            $("#dummy").append("<iframe src='/files/download" + data.cpath + data.cname + "'></iframe>");
        }).on('click', 'a.change-parent', function () {
            var data = table.row($(this).parents('tr')).data();

            var $curPath = $("#current-path");
            var curPath = $curPath.text();

            var finalPath = "/";
            if (curPath != '/') {
                var str = data.cname;
                var n = str.lastIndexOf("/");
                str = str.substr(0, n);
                n = str.lastIndexOf("/");
                finalPath = str.substr(0, n);
            }

            table.ajax.url("/api/files/r?path=" + finalPath);
            table.ajax.reload();

            $curPath.empty();
            $curPath.append(finalPath);
        }).on('click', 'button.delete-btn', function () {
            var data = table.row($(this).parents('tr')).data();

            BootstrapModalWrapperFactory.confirm({
                title: "Confirm",
                message: 'Are you sure to delete this file?',
                onConfirmAccept: function () {
                    $.post('/api/files/d',
                        {
                            fileName: data.cpath + data.cname
                        }, function (data) {
                            if (data == 'success') {
                                BootstrapModalWrapperFactory.alert('File deleted!');
                                table.ajax.reload();
                            } else {
                                BootstrapModalWrapperFactory.alert('Failed to delete File!');
                            }
                        });
                },
                onConfirmCancel: function () {
                }
            });

            // var dialogRef = BootstrapDialog.confirm('Are you sure to delete this file?', function (result) {
            //     if (result) {
            //         $.post('/api/files/d',
            //             {
            //                 fileName: data.cpath + data.cname
            //             }, function (data) {
            //                 if (data == 'success') {
            //                     dialogRef.close();
            //                     table.ajax.reload();
            //                     BootstrapDialog.alert('File deleted!');
            //                 } else {
            //                     BootstrapDialog.alert('Failed to delete file!');
            //                 }
            //             });
            //     }
            // });

        }).on('click', 'button.download-btn', function () {
            var data = table.row($(this).parents('tr')).data();
            $("#dummy").empty();
            $("#dummy").append("<iframe src='/files/download" + data.cpath + data.cname + "'></iframe>");
        });

        $(".refresh-btn").click(function () {
            table.ajax.reload();
        });

        // $(".delete-btn").click(function (event) {
        //     event.preventDefault();
        //     var fileName = $(this).attr('alt');
        //     alert(fileName);
        //     $.get('/api/files/d', {
        //         fileName: fileName
        //     }, function (data) {
        //         if (data == 'success') {
        //             alert('success');
        //         } else {
        //             alert('error');
        //         }
        //     });
        // });

        $(".upload-btn").click(function(){
            $("#upload-file").click();
        });

        $('#upload-file').on('change', function () {
            var file = this.files[0];

            var curPath = $("#current-path").text();

            if (file.size>0){
                $("#upload-filename").text(file.name);
                $("#upload-path").val(curPath+file.name);
                $("#upload-percent").text('0');

                $(".progress-bar")
                    .css('width','0%')
                    .attr('aria-valuenow',0);

                $.ajax({
                    // Your server script to process the upload
                    url: '/api/files/c',
                    type: 'POST',

                    // Form data
                    data: new FormData($('#upload-form')[0]),

                    // Tell jQuery not to process data or worry about content-type
                    // You *must* include these options!
                    cache: false,
                    contentType: false,
                    processData: false,

                    // Custom XMLHttpRequest
                    xhr: function () {
                        var myXhr = $.ajaxSettings.xhr();
                        if (myXhr.upload) {
                            // For handling the progress of the upload
                            myXhr.upload.addEventListener('progress', function (e) {
                                if (e.lengthComputable) {

                                    var percent = (e.loaded * 1.0 / e.total)*100;
                                    percent = parseInt(percent,10);

                                    $(".progress-bar")
                                        .css('width', percent +'%')
                                        .attr('aria-valuenow',percent)
                                        // .attr('aria-valuemax',e.total)
                                    ;

                                    $("#upload-percent").text(percent);
                                }
                            }, false);
                        }
                        return myXhr;
                    },

                    success: function () {
                        BootstrapModalWrapperFactory.alert('File uploaded!');
                        table.ajax.reload();
                    },

                    error: function (e) {
                        BootstrapModalWrapperFactory.alert('Failed to upload File!');
                        console.log(e);
                    }
                });
            }

            // if (file.size > 1024) {
            //     alert('max upload size is 1k')
            // }

            // Also see .name, .type
        });

    });
</script>
</html>